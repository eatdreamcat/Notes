# 曲线和表面

## Cubic Curves

由于其使用的简单和灵活性，三次多项式曲线再计算机图形中应用很广泛。一个基础的三次曲线可以由以下式子表示：
$$
Q(t) = a+bt+ct^2+dt^3
$$
![undefined](https://raw.githubusercontent.com/eatdreamcat/PicGo-01/main/Cubic_function.png)

其中$a$,$b$,$c$,$d$均为常向量，$Q(t)$​是曲线上关于t的一个点，将公式拆分为坐标轴分量形式，可以表示为:
$$
Q_x(t) = a_x+b_xt+c_xt^2+d_xt^3\\
Q_y(t) = a_y+b_yt+c_yt^2+d_yt^3\\
Q_z(t) = a_z+b_zt+c_zt^2+d_zt^3\\
$$
通过矩阵的方式来表示上述式子将更加方便，如下所示：
$$
Q(t) = \begin{bmatrix}a_x&b_x&c_x&d_x\\a_y&b_y&c_y&d_y\\a_z&b_z&c_z&d_z\end{bmatrix}\begin{bmatrix}1\\t\\t^2\\t^3\end{bmatrix}
$$
用更加紧（抽）凑（像）的符号表示，可以写成
$$
Q(t) = CT(t)
$$
这里的$C$代表矩阵的参数，$T(t)\equiv<1,t,t^2,t^3>$。$Q(t)$的导数可以代表曲线的t的位置时的切线方向，可以表示为如下：
$$
Q'(t)=C\frac{d}{dt}T(t)=C\begin{bmatrix}0\\1\\2t\\3t^3\end{bmatrix}
$$
一条很长的曲线可以看成是由多个分段的三次曲线连接端点组成的。在相邻的两个分段的连接点处，有参数连续性和几何连续性的概念。符号$C^n$用于表示n阶参数连续性，$G^n$用于表示n阶几何连续性。如果两个曲线在连接点处具有一样方向和大小的切线，则被成为具有$C^1$连续性。如果切线有同样的方向，但是不一样的大小，则被称为具有$G^1$连续性。通常来说，两个曲线如果n阶导相等，则$C^{n}$连续，如果n阶导不为0且方向相同，大小不同，则具有$G^{n}$连续。$C^{n}$连续就隐含了$G^{n}$连续，除非n阶导为0。而$C^0$和$G^0$​是等价的，表示曲线具有一样的端点。



**参数连续性确保了拼接的分段曲线，在区间内的是连续的。**

**几何连续性确保了在区间内，曲线是平滑的。**



本章节中我们定义的三次曲线，是通过特定的几何约束来表示的。例如端点位置（比如：$Q(0)$, Q(1)）或者端点的切向方向（比如：$Q'(0),Q’(1)$）。由于定义一个任意的三次曲线，需要四个参数来约束（因为有四个系数$a,b,c,d$，要求出四个系数，至少需要四个点代入才能解出来），我们将约束点命名为$g_1,g_2,g_3,g_4$，可以将$Q(t)$表示为：
$$
Q(t) = (a_1+b_1t+c_1t^2+d_1t^3)g_1\\+(a_2+b_2t+c_2t^2+d_2t^3)g_2\\+(a_3+b_3t+c_3t^2+d_3t^3)g_3\\+(a_4+b_4t+c_4t^2+d_4t^3)g_4\\
$$
上式可以看成是一个加权和的形式，而式子$a_i+b_it+c_it+d_it$又被称为blending funtions。写成矩阵形式如下：
$$
Q(t)=\begin{bmatrix}g_1&g_2&g_3&g_4\end{bmatrix}\begin{bmatrix}a_1&b_1&c_1&d_1\\a_2&b_2&c_2&d_2\\a_3&b_3&c_3&d_3\\a_4&b_4&c_4&d_4\end{bmatrix}\begin{bmatrix}1\\t\\t^2\\t^3\end{bmatrix}
$$
同样的，抽象写法如下：
$$
Q(t)=GMT(t)
$$
总结一下就是，任何曲线，都可以通过基函数和参数的叠加多项式来拟合，类似泰勒展开式的感觉。g就是权重参数，基函数一般用三次多项式来表示，至于为什么选用三次多项式，主要是由于三次多项式可以比较方便的构造出类似smoothstep的曲线。

![undefined](https://raw.githubusercontent.com/eatdreamcat/PicGo-01/main/1920px-Smoothstep_and_Smootherstep.svg.png)



关于上式的矩阵$G$,定义如下：
$$
G = \begin{bmatrix}g_1&g_2&g_3&g_4\end{bmatrix}=\begin{bmatrix}(g_1)_x&(g_2)_x&(g_3)_x&(g_4)_x\\(g_1)_y&(g_2)_y&(g_3)_y&(g_4)_y\\(g_1)_z&(g_2)_z&(g_3)_z&(g_4)_z\end{bmatrix}
$$
矩阵$M$定义如下：
$$
M=\begin{bmatrix}a_1&b_1&c_1&d_1\\a_2&b_2&c_2&d_2\\a_3&b_3&c_3&d_3\\a_4&b_4&c_4&d_4\\\end{bmatrix}
$$
$M$矩阵用来定义基函数，$G$​矩阵用来控制形状。





## Hermite Curves

一个三次Hermite曲线是由两个端点$P_1,P_2$，和对应的切线方向$T_1,T_2$来控制的。用这四个量来定义$G$矩阵，可以把Hermite曲线定义如下：


$$
H(t)=\begin{bmatrix}P_1&P_2&T_1&T_2\end{bmatrix}M_H\begin{bmatrix}1\\t\\t^2\\t^3\end{bmatrix}
$$
$M_H$是基函数的参数矩阵，$G$矩阵为$\begin{bmatrix}P_1&P_2&T_1&T_2\end{bmatrix}$。这里我们分别取两点（t=0和t=1），可以得到下面四个等式：
$$
H(0)  = \begin{bmatrix}P_1&P_2&T_1&T_2\end{bmatrix}M_H<1, 0, 0, 0> = P_1\\
H(1)= \begin{bmatrix}P_1&P_2&T_1&T_2\end{bmatrix}M_H<1, 1, 1, 1> = P_2\\
H'(0) = \begin{bmatrix}P_1&P_2&T_1&T_2\end{bmatrix}M_H<0, 1, 0, 0> = T_1\\
H’(1) = \begin{bmatrix}P_1&P_2&T_1&T_2\end{bmatrix}M_H<0, 1, 2, 3> = T_2\\
$$
将上式用矩阵的形式合并运算可以写成：
$$
\begin{bmatrix}P_1&P_2&T_1&T_2\end{bmatrix}M_H\begin{bmatrix}1&1&0&0\\0&1&1&1\\0&1&0&2\\0&1&0&3\end{bmatrix} = \begin{bmatrix}P_1&P_2&T_1&T_2\end{bmatrix}
$$
因此，可以推断出矩阵$M_{H}$其实就是右边常数矩阵的逆：
$$
M_H=\begin{bmatrix}1&1&0&0\\0&1&1&1\\0&1&0&2\\0&1&0&3\end{bmatrix}^{-1}=\begin{bmatrix}1&0&-3&2\\0&0&3&-2\\0&1&-2&1\\0&0&-1&1\end{bmatrix}
$$
得到参数矩阵后，可以把式子写成加权和的形式：
$$
H(t)=(1-3t^2+2t^3)P_1+t^2(3-2t)P_2+t(t-1)^2T_1+t^2(t-1)T_2
$$


通过上式可以看到，当t=0时，只有$P_1$的系数不为0，当t=1时，只有$P_2$的系数不为0。如下图所示：

![image-20240520175926206](https://raw.githubusercontent.com/eatdreamcat/PicGo-01/main/image-20240520175926206.png)



下图展示的是两个Hermite曲线的拼接，曲线分别为$H_1(t)$和$H_2(t)$，他们共享了一个端点$P_{2}$。如果曲线$H_1(t)$的几何矩阵是$\begin{bmatrix}P_1&P_2&T_1&T_2\end{bmatrix}$，并且曲线$H_2(t)$的几何矩阵是$\begin{bmatrix}P_2&P_3&\mu T_2&T_3\end{bmatrix} \space(\mu>0)$，则这两段曲线满足$G^1$连续，如果$\mu=1$则满足$C^1$连续。

![image-20240520181445730](https://raw.githubusercontent.com/eatdreamcat/PicGo-01/main/image-20240520181445730.png)



## Catmull-Rom Splines

给定一个有n+1个点的点集$\{P_0,P_1,...,P_n\} (n\ge3)$,Catmull-Rom spline会对点$\{P_1,P_2,...,P_{n-1}\}$进行分段的三次曲线插值。点$P_i$切线向量$T$由下面的公式给出：
$$
T_i=\frac{1}{2}(P_{i+1}-P_{i-1})
$$
我们可以用下面的式子表示每一个分段$C_i(t)$，当$1\le{i}\le{n-2}$,Hermite曲线有端点$P_i$和$P_{i+1}$，且切线$T_i$和$T_{i+1}$：
$$
C_{i}(t)=[P_i \space \space P_{i+1} \space \space T_{i} \space \space T_{i+1}]M_H\begin{bmatrix} 1 \\t\\t^2\\t^3\end{bmatrix}
$$
现在我们需要找到一个基础的矩阵$M_{CR}$，让我们可以用四个点来表示几何矩阵$G_{CR}$：
$$
[P_i \space \space P_{i+1} \space \space T_{i} \space \space T_{i+1}] = [P_{i-1}\space\space P_{i}\space\space P_{i+1}\space\space P_{i+2}]\begin{bmatrix}0&0&-\frac{1}{2}&0\\1&0&0&-\frac{1}{2}\\0&1&\frac{1}{2}&0\\0&0&0&\frac{1}{2}\end{bmatrix}
$$
将上面的式子代入，可以得到：
$$
M_{CR} = \frac{1}{2}\begin{bmatrix}0&0&-1&0\\2&0&0&-1\\0&2&1&0\\0&0&0&1\end{bmatrix}\begin{bmatrix}1&0&-3&2\\0&0&3&-2\\0&1&-2&1\\0&0&-1&1\end{bmatrix}=\frac{1}{2}\begin{bmatrix}0&-1&2&-1\\2&0&-5&3\\0&1&4&-3\\0&0&-1&1\end{bmatrix}
$$
现在，可以把分段样条的表达式写为：
$$
C_i(t)=\begin{bmatrix}P_{i-1}&P_{i}&P_{i+1}&P_{i+2}\end{bmatrix}M_{CR}\begin{bmatrix}1\\t\\t^2\\t^3\end{bmatrix}
$$
$\begin{bmatrix}P_{i-1}&P_{i}&P_{i+1}&P_{i+2}\end{bmatrix}$是几何矩阵$G_{CR}$ 。下图展示了一个由四个样条组成的曲线。



![image-20240520184718638](https://raw.githubusercontent.com/eatdreamcat/PicGo-01/main/image-20240520184718638.png)

### 代码实现



参考上文所述，实际上曲线上的每个点都是由四个控制点加权和得到的，自变量t用于控制权重。核心代码如下：

![image-20240522135103369](https://raw.githubusercontent.com/eatdreamcat/PicGo-01/main/image-20240522135103369.png)

仓库地址：

https://github.com/eatdreamcat/CurveRendering



