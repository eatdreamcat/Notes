# 布料模拟



一面在风中飘扬的旗帜和一个角色身后飘动的斗篷是使用布料模拟实现动画的两个例子。这个主题可能会变得非常复杂，但基本的矩形布料模拟可以相对容易地实现，并且能够产生逼真的效果。本节将描述一个简单布料模拟器的基本设计。

## 弹簧系统

布料可以看作是由一系列的点被排列成二维的格子的形式组成。我们只需要模拟这些点的运动就可以简单的模拟一个布料的运动。为了使其具有布料的一些特点，例如弹性，需要添加一些约束条件，比如点跟点之间需要由连接，会产生弹力和阻尼力。为了使布料具有连贯性并控制其运动，每个粒子通过虚拟弹簧和阻尼器与其多个相邻粒子连接。每个弹簧的作用是保持粒子之间的特定距离，而每个阻尼器则防止相邻粒子获得极其不同的速度。



下图展示了布料的弹簧系统，红色的线确保粒子不会分散或者塌缩，绿色的线可以防止出现对折的情况，蓝色的线则用于约束剪切运动。

![image-20240627143853662](https://raw.githubusercontent.com/eatdreamcat/PicGo-01/main/image-20240627143853662.png)





令$P$和$Q$分别表示相邻的两个点，$d$表示点之间的距离，这个距离是弹簧初始的平衡长度。而实际点跟点之间弹簧的长度则是另外的值。现在点受到的弹簧的力$F_{spring}$可以由下面的式子来表示：
$$
F_{spring}=k_{spring}(\|{Q-P}\|-d)\frac{Q-P}{\|Q-P\|}
$$
其中$k_{spring}$是弹簧系数常量，$F_{spring}$是点$P$受到的力，$-F_{spring}$是点Q受到的力。$d$为两点初始的平衡状态下的距离，例如如果$PQ$是对角线的点，则上式的$d$则应该是$d\sqrt{2}$。





如果$P$跟$Q$具有不一样的速度，则会产生阻尼力，可以由下式给出：
$$
F_{damper} = k_{damper}(\frac{dQ}{dt}-\frac{dP}{dt})
$$
其中$k_{damper}$是阻尼系数常量，$P$点受到$F_{damper}$的力，$Q$点受到$-F_{damper}$的力。



## 外部力



重力


$$
F_{gravity}=mg
$$
其中$m$表示质量，$g$是重力加速度，一般取$\{0,0,-9.8\}m/s^2$。



除了重力以外，最常见的就是来自风的外力。对于单位法线量为$N$的点$P$，受的风力可以表示为：
$$
F_{wind}=k_{wind}|(W-\frac{dP}{dt})·N|
$$
其中$W$表示风速，$k_{wind}$是风力系数常量。点乘法线也很好理解，当一面布料垂直于风向的时候，受力是最大的。





## 应用



对于布料上的每一个点，我们保存它的坐标和速度，通过在固定的时间间隔下更新坐标和速度，来实现布料的动画。这个时间间隔，是独立于帧率的，因此，每一帧的迭代次数会有变化。时间间隔在5到20毫秒之间通常会有一个比较好的模拟结果。



在一次模拟的迭代中，布料点的位置由当前的速度和所受到的所有力来决定的。一旦新的位置确定，就会计算出新的速度用于下一帧的迭代。



我们可以迭代所有的点并且独立的计算外力，对于第$i$个点，当前的位置$P_i$以及法线$N_i$，以及速度$V_i$，它所受的外力$F_{extern}$可以由下面的式子给出:
$$
F_{extern}=mg+k_{wind}|(W-V_i)·N_i|
$$
如果我们在迭代点时计算弹簧力和阻尼力，会导致我们需要对每个连接都计算两次，比较低效。另外对于连接数不一样的点，按照每个点去累加弹簧力和阻尼力也是不理想的方法。



这里我们初始化一个力的数组，每个点有一个入口，通过上面的公式来计算力的值。然后遍历迭代所有连接，计算每一个连接上的力，这个力会附加给连接的两个点。因为力的相对性，两个点的力大小一样，方向相反。



等到每一个点的总受力$F_i$计算出来，可以用下面的式子得出新的坐标位置$P_i$:
$$
P_i' = P_i + V_i\Delta{t} + \frac{F_i}{2m}(\Delta{t})^2
$$
当新的坐标计算出来，需要更新对应的切线向量和法线向量。由于位移贴图一般与Mesh的顶点一一对应，因此可以用差分法来计算切线和副切线。



## 实践





